<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Race Timetable â€“ Full Schedule</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Main Style -->
  <link rel="stylesheet" href="style.css" />

  <style>
  :root {
    --event-gap: 10px; /* ðŸ”§ Controla la separaciÃ³n entre cards */
  }

  /* ==========================
     Sticky day headers
  ========================== */
  .day-separator {
    position: sticky;
    top: 0;
    z-index: 5;
    width: 100%;
    margin: 12px 0 6px 0;
    background-color: #fefefe;
    color: #111;
    font-weight: 700;
    font-size: 1em;
    border-radius: 6px;
    padding: 6px 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    box-sizing: border-box;
  }

  /* ==========================
     Scrollable container
  ========================== */
  #all-events {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    height: calc(100vh - 90px);
    scroll-behavior: smooth;
    gap: var(--event-gap); /* ðŸŸ¡ Controla la separaciÃ³n entre grupos */
    padding: 12px 16px 20px 0;
    box-sizing: border-box;
  }

  #all-events::-webkit-scrollbar {
    width: 12px;
  }
  #all-events::-webkit-scrollbar-thumb {
    background-color: #333;
    border-radius: 10px;
  }

  /* ==========================
     Group of events (per day)
  ========================== */
  .day-group {
    display: flex;
    flex-direction: column;
    gap: var(--event-gap); /* ðŸŸ¢ Controla el espacio entre cards */
    padding-bottom: 10px;
  }

  /* ==========================
     Event cards
  ========================== */
  .event-card {
    position: relative;
    width: calc(100% - 16px);
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 14px 20px;
    display: grid;
    grid-template-columns: 1fr 2fr;
    align-items: center;
    gap: 12px;
    overflow: hidden;
    margin: 0 auto;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
  }

  .event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 16px rgba(255, 254, 0, 0.25);
  }

  /* Active background when event is in progress */
  .event-card.active {
    background-color: var(--tertiary-bg-active);
    box-shadow: 0 0 12px rgba(0, 255, 100, 0.25);
  }

  .badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 0.75em;
    font-weight: 700;
    color: #111;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 4px;
  }

  .badge.main { background-color: var(--accent-yellow); }
  .badge.secondary { background-color: #ccc; color: #111; }
  .badge.tertiary { background-color: #777; color: #111; }

  .info-left {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    text-align: left;
    gap: 4px;
  }

  .info-left .title {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--text-color);
    line-height: 1.2;
  }

  .info-right {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 6px;
    text-align: right;
  }

  .info-right .datetime {
    font-size: 1em;
    color: var(--secondary-text);
  }

  .info-right .description {
    font-size: 1em;
    color: var(--text-color);
  }

  /* Progress bar like index.html */
  .progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    background: var(--accent-green);
    width: 0%;
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
    transition: width 0.5s linear;
  }

  @media (max-width: 800px) {
    .event-card {
      grid-template-columns: 1fr;
      text-align: left;
    }
    .info-right {
      text-align: left;
    }
  }
</style>

</head>

<body>
  <!-- ==========================
       HEADER
  ========================== -->
  <header>
    <div class="logo" style="cursor:pointer;" onclick="window.location.href='index.html'">
      <img src="logo.svg" alt="Iron Lynx Logo" class="logo-img" />
    </div>

    <div class="header-title">2025 FIA WEC - Bahrain</div>

    <div id="current-datetime" style="cursor:pointer;" onclick="window.location.href='index.html'">
      <div class="date-line">Loadingâ€¦</div>
      <div class="time-line">--:--:--</div>
    </div>
  </header>

  <!-- ==========================
       MAIN CONTENT
  ========================== -->
  <main>
    <div id="all-events"></div>
  </main>

  <!-- ==========================
       SCRIPT
  ========================== -->
  <script>
// ==============================================
// ðŸ“… LOAD AND PARSE EVENTS (Outlook-compatible)
// ==============================================
async function loadAllEvents() {
  const container = document.getElementById("all-events");
  try {
    const resp = await fetch(
      "https://corsproxy.io/?" +
      encodeURIComponent(
        "https://outlook.office365.com/owa/calendar/46dbe62f2a1b4a81bfe272e8ef89baee@ironlynx.it/955ed78282564a95838e1cf67a4b834812868820346018730469/calendar.ics"
      )
    );

    const icsText = await resp.text();
    const events = parseICS(icsText);
    events.sort((a, b) => new Date(a.start) - new Date(b.start));

    container.innerHTML = "";
    renderEventsByDay(events, container);
    scrollToCurrentEvent(events);
  } catch (err) {
    console.error(err);
    container.innerHTML = "Error loading ICS events.";
  }
}

// ==============================================
// ðŸ“† ROBUST ICS PARSER (handles TZID like "Romance Standard Time")
// ==============================================
function matchFieldWithParams(block, key) {
  const regex = new RegExp(`${key}((?:;[^:]+)*)?:([^\\n\\r]+)`);
  const match = block.match(regex);
  if (!match) return null;
  const rawParams = match[1] || "";
  const value = match[2].trim();
  const params = {};
  if (rawParams) {
    const parts = rawParams.split(";").filter(Boolean);
    parts.forEach(p => {
      const [k, v] = p.split("=");
      if (k) params[k.toUpperCase()] = v ? v : true;
    });
  }
  return { params, value };
}

const WINDOWS_TO_IANA = {
  "romance standard time": "Europe/Madrid",
  "w. europe standard time": "Europe/Berlin",
  "central europe standard time": "Europe/Budapest",
  "gmt standard time": "Europe/London",
  "eastern standard time": "America/New_York",
  "cet": "Europe/Paris"
};

function tzLocalToISOString(year, month, day, hour, minute, second, timeZone) {
  const target = {
    year: String(year).padStart(4, "0"),
    month: String(month).padStart(2, "0"),
    day: String(day).padStart(2, "0"),
    hour: String(hour).padStart(2, "0"),
    minute: String(minute).padStart(2, "0"),
    second: String(second).padStart(2, "0"),
  };

  const dtf = new Intl.DateTimeFormat("en-GB", {
    timeZone,
    hour12: false,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });

  function formatParts(ts) {
    const parts = dtf.formatToParts(new Date(ts));
    const out = {};
    for (const p of parts) {
      if (p.type !== "literal") out[p.type] = p.value;
    }
    return out;
  }

  const guess = Date.UTC(year, month - 1, day, hour, minute, second);
  let low = guess - 36 * 3600 * 1000;
  let high = guess + 36 * 3600 * 1000;

  for (let i = 0; i < 60; i++) {
    const mid = Math.floor((low + high) / 2);
    const parts = formatParts(mid);

    const midValue = `${parts.year}${parts.month}${parts.day}${parts.hour}${parts.minute}${parts.second}`;
    const targetValue = `${target.year}${target.month}${target.day}${target.hour}${target.minute}${target.second}`;

    if (midValue === targetValue) return new Date(mid).toISOString();
    if (midValue < targetValue) low = mid + 1;
    else high = mid - 1;
  }

  return new Date(Date.UTC(year, month - 1, day, hour, minute, second)).toISOString();
}

function parseICSTimeWithParams(value, params = {}) {
  if (!value) return null;
  if (/^\d{8}$/.test(value))
    return `${value.slice(0,4)}-${value.slice(4,6)}-${value.slice(6,8)}T00:00:00Z`;

  if (/^\d{8}T\d{6}Z$/.test(value))
    return `${value.slice(0,4)}-${value.slice(4,6)}-${value.slice(6,8)}T${value.slice(9,11)}:${value.slice(11,13)}:${value.slice(13,15)}Z`;

  if (/^\d{8}T\d{6}$/.test(value)) {
    const year = Number(value.slice(0,4));
    const month = Number(value.slice(4,6));
    const day = Number(value.slice(6,8));
    const hour = Number(value.slice(9,11));
    const minute = Number(value.slice(11,13));
    const second = Number(value.slice(13,15));

    if (params && params.TZID) {
      const tzid = params.TZID;
      const mapped = WINDOWS_TO_IANA[tzid.toLowerCase()];
      const iana = mapped || tzid;
      try {
        return tzLocalToISOString(year, month, day, hour, minute, second, iana);
      } catch {
        return new Date(year, month - 1, day, hour, minute, second).toISOString();
      }
    }

    return new Date(year, month - 1, day, hour, minute, second).toISOString();
  }

  const parsed = new Date(value);
  if (!isNaN(parsed.getTime())) return parsed.toISOString();
  return null;
}

function parseICS(text) {
  const events = [];
  const normalized = text.replace(/\r\n/g, "\n").replace(/\n /g, "");
  const blocks = normalized.split("BEGIN:VEVENT").slice(1);
  for (const block of blocks) {
    const endBlock = block.split("END:VEVENT")[0];
    const summary = matchField(endBlock, "SUMMARY") || "Untitled";
    const description = matchField(endBlock, "DESCRIPTION") || "";
    const startRaw = matchFieldWithParams(endBlock, "DTSTART");
    const endRaw = matchFieldWithParams(endBlock, "DTEND");
    const category = (matchField(endBlock, "CATEGORIES") || "secondary").toLowerCase();

    const startISO = parseICSTimeWithParams(startRaw?.value, startRaw?.params);
    const endISO = parseICSTimeWithParams(endRaw?.value, endRaw?.params);

    events.push({ title: summary, description, start: startISO, end: endISO, category });
  }
  return events;
}

function matchField(block, key) {
  const regex = new RegExp(`${key}(?:;[^:]+)?:([^\n\r]+)`);
  const match = block.match(regex);
  if (!match) return null;
  return match[1].trim().replace(/\\n/g, "\n").replace(/\\\\/g, "\\");
}

// ==============================================
// ðŸ§© RENDER EVENTS BY DAY
// ==============================================
function renderEventsByDay(events, container) {
  const grouped = groupEventsByDay(events);
  Object.keys(grouped).forEach(day => {
    const dayGroup = document.createElement("div");
    dayGroup.className = "day-group";

    const dayHeader = document.createElement("div");
    dayHeader.className = "day-separator";
    dayHeader.textContent = formatDayLabel(day);

    dayGroup.appendChild(dayHeader);

    grouped[day].forEach(ev => {
      const card = createEventCard(ev);
      dayGroup.appendChild(card);
      updateProgress(ev, card);
      setInterval(() => updateProgress(ev, card), 1000);
    });

    container.appendChild(dayGroup);
  });
}

function groupEventsByDay(events) {
  const groups = {};
  events.forEach(ev => {
    const dayKey = new Date(ev.start).toISOString().split("T")[0];
    if (!groups[dayKey]) groups[dayKey] = [];
    groups[dayKey].push(ev);
  });
  return groups;
}

function formatDayLabel(dateString) {
  const d = new Date(dateString);
  return d.toLocaleDateString("en-GB", {
    weekday: "long",
    day: "2-digit",
    month: "long",
    year: "numeric",
  });
}

function createEventCard(ev) {
  const card = document.createElement("div");
  card.className = "event-card " + ev.category;
  card.innerHTML = `
    <div class="info-left">
      <div class="title">${ev.title}</div>
      <div class="badge ${ev.category}">${ev.category}</div>
    </div>
    <div class="info-right">
      <div class="datetime">${formatTime(ev.start)} â€” ${formatTime(ev.end)}</div>
      <div class="description">${ev.description}</div>
    </div>
    <div class="progress-bar"></div>
  `;
  return card;
}

function updateProgress(ev, card) {
  const now = new Date().getTime();
  const start = new Date(ev.start).getTime();
  const end = new Date(ev.end).getTime();
  const progress = card.querySelector(".progress-bar");

  if (now >= start && now < end) {
    const total = end - start;
    const elapsed = now - start;
    const percent = (elapsed / total) * 100;
    progress.style.width = percent + "%";
    progress.style.display = "block";
  } else {
    progress.style.display = "none";
  }
}

function formatTime(dtStr) {
  const d = new Date(dtStr);
  return d.toLocaleTimeString("en-GB", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  });
}

function updateCurrentDateTime() {
  const now = new Date();
  document.querySelector("#current-datetime .date-line").textContent =
    now.toLocaleDateString("en-GB", {
      weekday: "long",
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  document.querySelector("#current-datetime .time-line").textContent =
    now.toLocaleTimeString("en-GB", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
}

function scrollToCurrentEvent(events) {
  const now = Date.now();
  const currentOrNext = events.find(ev => new Date(ev.end).getTime() > now);
  if (currentOrNext) {
    setTimeout(() => {
      const cards = document.querySelectorAll(".event-card");
      for (const card of cards) {
        if (card.querySelector(".title").textContent === currentOrNext.title) {
          card.scrollIntoView({ behavior: "smooth", block: "center" });
          break;
        }
      }
    }, 800);
  }
}

// ==============================================
// ðŸš€ INIT
// ==============================================
setInterval(updateCurrentDateTime, 1000);
updateCurrentDateTime();
loadAllEvents();
</script>

</body>
</html>
